<!DOCTYPE html>
<html lang="en">
<head>
  <title>Task Tracker</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script>
    const handleResponse = async (response) => {
      const backlog = document.querySelector('#backlog');
      const doing = document.querySelector('#doing');
      const completed = document.querySelector('#completed');
	  
      // get the json response
	  let obj = await response.json();
      console.log(obj);

      // if there is a message, return
      if(obj.message) {
        console.log(obj.message);
        return;
      }

      backlog.innerHTML = ``;
      doing.innerHTML = ``;
      completed.innerHTML = ``;

      for(const task in obj.tasks) {
        switch(obj.tasks[task]) {
            case "backlog":
                backlog.innerHTML += `<div>${task}</div>`;
                break;
            case "doing":
                doing.innerHTML += `<div>${task}</div>`;
                break;
            case "completed":
                completed.innerHTML += `<div>${task}</div>`;
                break;
        }
      }
      
    };
	
	const sendPost = async (taskForm) => {
      const formAction = taskForm.getAttribute('action');
      const formMethod = taskForm.getAttribute('method');

      const name = taskForm.querySelector('#taskName').value;
      const stage = taskForm.querySelector('#stageSelect').value;

      const formData = `name=${name}&stage=${stage}`;

      let response = await fetch(formAction, {
        method: formMethod,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: formData,
      });

      handleResponse(response);
    };
	
	const requestUpdate = async (taskForm) => {
		const url = '/getTasks'
		const method = 'get';
      
		let response = await fetch(url, {
			method,
			headers: {
				'Accept': 'application/json',
			},
		});

		handleResponse(response);
    };

    const init = () => {
	  const taskForm = document.querySelector('#taskForm');
      const updateButton = document.querySelector('#getTasks');
      
	  const addTask = (e) => {
		e.preventDefault();
		sendPost(taskForm);
		return false;
	  }
      const getTasks = () => {
        requestUpdate(taskForm);
	  }
	  
	  taskForm.addEventListener('submit', addTask);
      updateButton.addEventListener('click', getTasks);

    };

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h3>Task Tracker</h3>
    <form id="taskForm" action="/setTask" method="post">
      <label for="name">Task Name: </label>
      <input id="taskName" type="text" name="name" />
      <select id='stageSelect'>
        <option value='backlog'>Backlog</option>
        <option value='doing'>Doing</option>
        <option value='completed'>Completed</option>
      </select>
      <input type="submit" value="Set Task" id="setTask" />
    </form>
    <button id="getTasks">Update Tasks</button>
  </section>
  <section id="content">
    <h4>Backlog</h4>
    <div id="backlog"></div>
    <h4>Doing</h4>
    <div id="doing"></div>
    <h4>Completed</h4>
    <div id="completed"></div>
  </section>
</body>
</html>